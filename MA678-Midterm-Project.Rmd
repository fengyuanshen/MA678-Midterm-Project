---
title: "MA678-Midterm-Project"
output: 
  pdf_document: 
    latex_engine: xelatex
author: Fengyuan Shen (Vincent)
date: "2023-12-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Abstract

## Introduction

## Method

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(leaflet)
library(ggmap)
library(reshape2)
library(gridExtra)
library(lubridate)
library(stringr)
library(kableExtra)
```

```{r echo=FALSE}
# listings <- read.csv("data/listings.csv", header = T)
# calendar <- read.csv("data/calendar.csv", header = T)
# reviews <- read.csv("data/reviews.csv", header = T)
```

```{r echo=FALSE}
# Combine data
# file_list <- list.files(path = "listings_data", pattern = "*.csv", full.names = TRUE)
# combined_data <- bind_rows(lapply(file_list, read.csv))
# write.csv(combined_data, "listings_data/listings.csv", row.names = FALSE)
```

```{r echo=FALSE}
# read csv
listings <- read.csv("data/listings.csv", header = T)
```

### Data Cleaning

```{r echo=FALSE}
listings_data <- listings |> 
  select(id, host_id, host_name, host_since, host_response_time, host_response_rate,
         host_acceptance_rate, host_is_superhost, host_listings_count, 
         host_identity_verified, latitude, longitude, property_type, room_type,
         accommodates, bathrooms_text, bedrooms, beds, price, minimum_nights,
         maximum_nights, number_of_reviews, review_scores_rating, review_scores_accuracy,
         review_scores_cleanliness, review_scores_checkin, review_scores_communication,
         review_scores_location, review_scores_value, instant_bookable)
```

```{r echo=FALSE}
kable(head(listings_data[,c(3,4,16:19,23)]))
```

```{r echo=FALSE}
summary(listings_data)
```

```{r echo=FALSE}
# Price
# Omit missing values
listings_data <- na.omit(listings_data)

# Converts the data format of the Price column
listings_data$price <- as.numeric(str_replace_all(listings_data$price, "[^0-9.]", ""))

# Remove outliers in the Price column
Q1 <- quantile(listings_data$price, 0.25)
Q3 <- quantile(listings_data$price, 0.75)
IQR <- Q3 - Q1
lower_bound <- Q1 - 1.5 * IQR
upper_bound <- Q3 + 1.5 * IQR
listings_data <- listings_data |> filter(price >= lower_bound & price <= upper_bound)
```

within an hour = 0, within a few hours = 1, a few days or more = 2.

```{r echo=FALSE}
# Host response
# Converts categorical variables to numeric types
listings_data <- listings_data |> 
  mutate(host_response_time = case_when(
    host_response_time == "within an hour" ~ 0,
    host_response_time == "within a few hours" ~ 1,
    host_response_time  == "a few days or more" ~ 2,
    TRUE ~ NA  # If neither match, set the column to NA
  )) |> 
  filter(!is.na(host_response_time)) # Filter out rows with NA values
```

f = 0, t = 1.

```{r echo=FALSE}
# Host is superhost
listings_data <- listings_data |> filter(host_is_superhost %in% c('f','t'))
# Converts categorical variables to numeric types
listings_data$host_is_superhost <- ifelse(listings_data$host_is_superhost == 'f', 0, 1)
```

f = 0, t = 1.

```{r echo=FALSE}
# Host identify verified
listings_data <- listings_data |> filter(host_identity_verified %in% c('f','t'))
# Converts categorical variables to numeric types
listings_data$host_identity_verified <- ifelse(listings_data$host_identity_verified == 'f',
                                               0, 1)
```

f = 0, t = 1.

```{r echo=FALSE}
# Instant bookable
listings_data <- listings_data |> filter(instant_bookable %in% c('f','t'))
# Converts categorical variables to numeric types
listings_data$instant_bookable <- ifelse(listings_data$instant_bookable == 'f', 0, 1)
```

```{r echo=FALSE, warning=FALSE}
# Converts a percentage string to a numeric type
listings_data$host_response_rate <- 
  as.numeric(sub("%", "", listings_data$host_response_rate)) / 100
listings_data$host_acceptance_rate <- 
  as.numeric(sub("%", "", listings_data$host_acceptance_rate)) / 100
listings_data <- drop_na(listings_data, host_response_rate, host_acceptance_rate)
```

```{r echo=FALSE}
# Bathrooms text
listings_data <- listings_data |> 
  mutate(bathrooms = case_when(
    bathrooms_text %in% c("Half-bath", "Shared half-bath") ~ 0.5,
    bathrooms_text %in% c("1 bath", "1 shared bath", "1 private bath") ~ 1,
    bathrooms_text %in% c("1.5 baths", "1.5 shared baths") ~ 1.5,
    bathrooms_text %in% c("2 baths", "2 shared baths") ~ 2,
    bathrooms_text %in% c("2.5 baths") ~ 2.5,
    bathrooms_text %in% c("3 baths", "3 shared baths") ~ 3,
    bathrooms_text %in% c("3.5 baths", "3.5 shared baths") ~ 3.5,
    bathrooms_text %in% c("4 baths") ~ 4,
    bathrooms_text %in% c("4.5 baths") ~ 4.5,
    bathrooms_text %in% c("5 baths") ~ 5,
    bathrooms_text %in% c("5.5 baths") ~ 5.5,
    bathrooms_text %in% c("6 baths") ~ 6,
    bathrooms_text %in% c("7 baths") ~ 7,
    bathrooms_text %in% c("7.5 baths") ~ 7.5,
    bathrooms_text %in% c("8 baths") ~ 8,
    bathrooms_text %in% c("11 baths", "11 shared baths", "11.5 shared baths") ~ 11,
    bathrooms_text %in% c("11.5 shared baths") ~ 11.5,
    TRUE ~ NA_real_  # For other values, set to NA
  )) |> 
  filter(!is.na(bathrooms)) |>   # Remove rows with NA in bathrooms
  # Keep bathrooms column after bathrooms_text
  relocate(bathrooms, .after = bathrooms_text) |>   
  select(-bathrooms_text)  # Remove the old bathrooms_text column
```

Entire home/apt = 0, Private room = 1, Hotel room = 2.

```{r echo=FALSE}
# Room type
listings_data <- listings_data |> 
  mutate(room = case_when(
    room_type %in% c("Entire home/apt") ~ 0,
    room_type %in% c("Private room") ~ 1,
    room_type %in% c("Hotel room") ~ 2,
    TRUE ~ NA_real_  # For other values, set to NA
  )) |> 
  filter(!is.na(room)) |>  # Remove rows with NA in room_type
  # Keep room column after bathrooms_text
  relocate(room, .after = room_type)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# write.csv(listings_data, "listings_data.csv")
```

### EDA

```{r echo=FALSE}
# Heatmap
# Select numerical columns for correlation analysis
numeric_data <- listings_data[, c('host_response_time', 'host_response_rate',
                                  'host_acceptance_rate', 'host_is_superhost',
                                  'host_listings_count', 'host_identity_verified',
                                  'latitude', 'longitude', 'room', 'accommodates',
                                  'bathrooms', 'bedrooms', 'beds', 'price', 'minimum_nights',
                                  'maximum_nights', 'number_of_reviews', 
                                  'review_scores_rating', 'review_scores_accuracy',
                                  'review_scores_cleanliness', 'review_scores_checkin',
                                  'review_scores_communication', 'review_scores_location',
                                  'review_scores_value', 'instant_bookable')]

# Correlation matrix
correlation_matrix <- cor(numeric_data, use="complete.obs")

# Heatmap
melted_correlation <- melt(correlation_matrix)
ggplot(data = melted_correlation, aes(Var1, Var2, fill = value)) +
    geom_tile() +
    geom_text(aes(label = sprintf("%.2f", value)), size = 1.5, vjust = 0.5) +
    scale_fill_gradientn(colours = c("#03045E", "#023E8A", "#277DA1", "#577590", "#4D908E",
                                     "#43AA8B", "#90BE6D", "#F9C74F", "#F9844A", "#F8961E",
                                     "#F3722C", "#F94144", "#DC2F02", "#D00000"),
                         limits = c(-1, 1)) +
    theme_minimal() +
    labs(title = "Correlation Matrix of Variables", x = '', y = '') +
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.text.x = element_text(angle = 45, hjust = 1)
      )
```

rate那里无所谓，但是中间那一块感觉会存在共线性问题

另外，相关系数矩阵仅仅表示不同变量之间是否存在线性关系，但有时候关系有可能是非线性的。（比如地理位置和价格）

找找哪些因素和price相关，然后绘制图形：

host_is_superhost, latitude and longitude, room_type, accommodates, bathrooms, bedrooms, beds, minimum_nights, number_of_reviews, review_scores_ratings, review_scores_location

```{r echo=FALSE}
# Price Distribution
ggplot(listings_data, aes(x = price)) +
  geom_histogram(binwidth = 10, fill = "#D62828", color = "black") +
  geom_density(aes(y = after_stat(count) * 10), color = "#003566", linewidth = 1) +
  labs(title = "Price Distribution", x = "Price", y = "Frequency") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

```{r echo=FALSE,message=FALSE,warning=FALSE}
# Scatter plot of the relationship between location and price
register_stadiamaps(key = "5a10d16e-591e-4614-be7c-c5294374aac7")
los_angeles_map <- get_stadiamap(bbox = c(left = -118.55, bottom = 33.95, right = -118.15, 
                                          top = 34.25), zoom = 12, maptype = "outdoors")
```

```{r echo=FALSE,warning=FALSE}
ggmap(los_angeles_map) +
  geom_point(data = listings_data, aes(x = longitude, y = latitude, color = price), 
             size = 1.5, alpha = 0.7) +
  scale_color_gradientn(colors = rev(RColorBrewer::brewer.pal(11, "RdYlBu"))) +
  labs(
    title = "Geographic Distribution of Listings Price in Los Angeles",
    x = "Longitude", y = "Latitude",
    color = "Price") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

```{r echo=FALSE}
# Room Type Distribution
ggplot(listings_data, aes(reorder(room_type, room_type, function(x) -length(x)), fill = room_type)) +
  geom_bar(color = "black") +
  scale_fill_manual(values = c("#D62828", "#F77F00", "#457B9D")) +
  labs(title = "Room Type Distribution", x = "Room Type", y = "Count") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  ) +
  geom_text(
    aes(label = after_stat(count)),
    stat = "count",
    position = position_stack(vjust = 0.5),
    color = c("white", "white", "black"),
    size = 4.5
  )
```

```{r echo=FALSE}
# Price Distribution of Different Room Types
# boxplot
ggplot(listings_data, aes(x = room_type, y = price, fill = room_type)) +
  geom_boxplot() +
  # scale_fill_brewer(palette = "Set2") +
  scale_fill_manual(values = c("#D62828", "#F77F00", "#457B9D")) +
  theme_minimal() +
  labs(title = "Price Distribution of Different Room Types",
       x = "Room Type",
       y = "Price") +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

```{r echo=FALSE,message=FALSE,warning=FALSE}
# Price vs Accommodates
p1 <- ggplot(listings_data, aes(x = accommodates, y = price)) +
  geom_point(color = "#003049", alpha = 0.6) +
  geom_smooth(method = "lm", color = "#FFBD00") +  # Add a linear model trendline
  labs(title = "Price vs Accommodates", x = "Accommodates", y = "Price") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

```{r echo=FALSE,message=FALSE,warning=FALSE}
# Price vs Bathrooms
p2 <- ggplot(listings_data, aes(x = bathrooms, y = price)) +
  geom_point(color = "#D62828",alpha = 0.6) +
  geom_smooth(method = "lm", color = "#023E8A") +
  labs(title = "Price vs Bathrooms", x = "Bathrooms", y = "Price") +
  ylim(c(0, 700)) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

```{r echo=FALSE,message=FALSE,warning=FALSE}
# Price vs Bedrooms
p3 <- ggplot(listings_data, aes(x = bedrooms, y = price)) +
  geom_point(color = "#F77F00", alpha = 0.6) +
  geom_smooth(method = "lm", color = "#C1121F") +
  labs(title = "Price vs Bedrooms", x = "Bedrooms", y = "Price") +
  xlim(c(0, 20)) +
  ylim(c(0, 700)) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

```{r echo=FALSE,message=FALSE,warning=FALSE}
# Price vs Beds
p4 <- ggplot(listings_data, aes(x = beds, y = price)) +
  geom_point(color = "#FCBF49", alpha = 0.6) +
  geom_smooth(method = "lm", color = "#6A994E") +
  labs(title = "Price vs Beds", x = "Beds", y = "Price") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

```{r fig.width=8,fig.height=6,echo=FALSE,message=FALSE,warning=FALSE}
grid.arrange(p1, p2, p3, p4, nrow = 2)
```

看一下评分数量的分布，来决定评分是否可以作为预测价格的指标

```{r echo=FALSE,warning=FALSE}
# Distribution for Number of Reviews
ggplot(listings_data, aes(x = number_of_reviews)) +
  geom_histogram(binwidth = 20, fill = "#DA2C38", color = "black") +
  geom_density(aes(y = after_stat(count) * 10), color = "#226F54", linewidth = 1) +
  xlim(c(0,500)) +
  ylim(c(0,4000)) +
  labs(title = "Distribution for Number of Reviews", x = "Number of Reviews", y = "Count") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

画一张评分和价格的关系图

```{r echo=FALSE,message=FALSE,warning=FALSE}
# Price vs Overall Rating
p5 <- ggplot(listings_data, aes(x = review_scores_rating, y = price)) +
  geom_point(color = "#003049", alpha = 0.6) +
  geom_smooth(method = "lm", color = "#FFBD00") +  # Add a linear model trendline
  labs(title = "Price vs Overall Rating", x = "Overall Rating", y = "Price") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

# Price vs Accuray Rating
p6 <- ggplot(listings_data, aes(x = review_scores_accuracy, y = price)) +
  geom_point(color = "#D62828",alpha = 0.6) +
  geom_smooth(method = "lm", color = "#023E8A") +
  labs(title = "Price vs Accuray Rating", x = "Accuray Rating", y = "Price") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

# Price vs Cleanliness Rating
p7 <- ggplot(listings_data, aes(x = review_scores_cleanliness, y = price)) +
  geom_point(color = "#F77F00", alpha = 0.6) +
  geom_smooth(method = "lm", color = "#C1121F") +
  labs(title = "Price vs Cleanliness Rating", x = "Cleanliness Rating", y = "Price") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

# Price vs Checkin Rating
p8 <- ggplot(listings_data, aes(x = review_scores_checkin, y = price)) +
  geom_point(color = "#FCBF49", alpha = 0.6) +
  geom_smooth(method = "lm", color = "#6A994E") +
  labs(title = "Price vs Checkin Rating", x = "Checkin Rating", y = "Price") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

# Price vs Communication Rating
p9 <- ggplot(listings_data, aes(x = review_scores_communication, y = price)) +
  geom_point(color = "#226F54", alpha = 0.6) +
  geom_smooth(method = "lm", color = "#DA2C38") +
  labs(title = "Price vs Communication Rating", x = "Communication Rating", y = "Price") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

# Price vs Location Rating
p10 <- ggplot(listings_data, aes(x = review_scores_location, y = price)) +
  geom_point(color = "#5E548E", alpha = 0.6) +
  geom_smooth(method = "lm", color = "#9E2A2B") +
  labs(title = "Price vs Location Rating", x = "Location Rating", y = "Price") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

# Price vs Value Rating
p11 <- ggplot(listings_data, aes(x = review_scores_value, y = price)) +
  geom_point(color = "#FFD60A", alpha = 0.6) +
  geom_smooth(method = "lm", color = "#003566") +
  labs(title = "Price vs Value Rating", x = "Value Rating", y = "Price") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

```{r fig.width=8,fig.height=14,echo=FALSE,message=FALSE,warning=FALSE}
grid.arrange(p5, p6, p7, p8, p9, p10, p11, ncol = 2)
```

### Fitting Model

#### Model1: Linear Regression

#### Residual plot

## Result

## Discussion

## Appendix
