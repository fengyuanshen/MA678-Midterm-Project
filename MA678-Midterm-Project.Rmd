---
title: "MA678-Midterm-Project"
output: 
  pdf_document: 
    latex_engine: xelatex
author: Fengyuan Shen (Vincent)
date: "2023-12-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Abstract

## Introduction

## Method

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(leaflet)
library(ggmap)
library(reshape2)
library(lubridate)
library(stringr)
library(kableExtra)
```

```{r echo=FALSE}
# listings <- read.csv("data/listings.csv", header = T)
# calendar <- read.csv("data/calendar.csv", header = T)
# reviews <- read.csv("data/reviews.csv", header = T)
```

```{r echo=FALSE}
# Combine data
# file_list <- list.files(path = "listings_data", pattern = "*.csv", full.names = TRUE)
# combined_data <- bind_rows(lapply(file_list, read.csv))
# write.csv(combined_data, "listings_data/listings.csv", row.names = FALSE)
```

```{r echo=FALSE}
# read csv
listings <- read.csv("data/listings.csv", header = T)
```

### Data Cleaning

```{r echo=FALSE}
listings_data <- listings |> 
  select(id, host_id, host_name, host_since, host_response_time, host_response_rate,
         host_acceptance_rate, host_is_superhost, host_listings_count, 
         host_identity_verified, latitude, longitude, property_type, room_type,
         accommodates, bathrooms_text, bedrooms, beds, price, minimum_nights,
         maximum_nights, number_of_reviews, review_scores_rating, review_scores_accuracy,
         review_scores_cleanliness, review_scores_checkin, review_scores_communication,
         review_scores_location, review_scores_value, instant_bookable)
```

```{r echo=FALSE}
kable(head(listings_data[,c(3,4,16:19,23)]))
```

```{r echo=FALSE}
summary(listings_data)
```

```{r echo=FALSE}
# Price
# Omit missing values
listings_data <- na.omit(listings_data)

# Converts the data format of the Price column
listings_data$price <- as.numeric(str_replace_all(listings_data$price, "[^0-9.]", ""))

# Remove outliers in the Price column
Q1 <- quantile(listings_data$price, 0.25)
Q3 <- quantile(listings_data$price, 0.75)
IQR <- Q3 - Q1
lower_bound <- Q1 - 1.5 * IQR
upper_bound <- Q3 + 1.5 * IQR
listings_data <- listings_data |> filter(price >= lower_bound & price <= upper_bound)
```

within an hour = 0, within a few hours = 1, a few days or more = 2.

```{r echo=FALSE}
# Host response
# Converts categorical variables to numeric types
listings_data <- listings_data |> 
  mutate(host_response_time = case_when(
    host_response_time == "within an hour" ~ 0,
    host_response_time == "within a few hours" ~ 1,
    host_response_time  == "a few days or more" ~ 2,
    TRUE ~ NA  # If neither match, set the column to NA
  )) |> 
  filter(!is.na(host_response_time)) # Filter out rows with NA values
```

f = 0, t = 1.

```{r echo=FALSE}
# Host is superhost
listings_data <- listings_data |> filter(host_is_superhost %in% c('f','t'))
# Converts categorical variables to numeric types
listings_data$host_is_superhost <- ifelse(listings_data$host_is_superhost == 'f', 0, 1)
```

f = 0, t = 1.

```{r echo=FALSE}
# Host identify verified
listings_data <- listings_data |> filter(host_identity_verified %in% c('f','t'))
# Converts categorical variables to numeric types
listings_data$host_identity_verified <- ifelse(listings_data$host_identity_verified == 'f',
                                               0, 1)
```

f = 0, t = 1.

```{r echo=FALSE}
# Instant bookable
listings_data <- listings_data |> filter(instant_bookable %in% c('f','t'))
# Converts categorical variables to numeric types
listings_data$instant_bookable <- ifelse(listings_data$instant_bookable == 'f', 0, 1)
```

```{r echo=FALSE, warning=FALSE}
# Converts a percentage string to a numeric type
listings_data$host_response_rate <- 
  as.numeric(sub("%", "", listings_data$host_response_rate)) / 100
listings_data$host_acceptance_rate <- 
  as.numeric(sub("%", "", listings_data$host_acceptance_rate)) / 100
listings_data <- drop_na(listings_data, host_response_rate, host_acceptance_rate)
```

```{r echo=FALSE}
# Bathrooms text
listings_data <- listings_data |> 
  mutate(bathrooms = case_when(
    bathrooms_text %in% c("Half-bath", "Shared half-bath") ~ 0.5,
    bathrooms_text %in% c("1 bath", "1 shared bath", "1 private bath") ~ 1,
    bathrooms_text %in% c("1.5 baths", "1.5 shared baths") ~ 1.5,
    bathrooms_text %in% c("2 baths", "2 shared baths") ~ 2,
    bathrooms_text %in% c("2.5 baths") ~ 2.5,
    bathrooms_text %in% c("3 baths", "3 shared baths") ~ 3,
    bathrooms_text %in% c("3.5 baths", "3.5 shared baths") ~ 3.5,
    bathrooms_text %in% c("4 baths") ~ 4,
    bathrooms_text %in% c("4.5 baths") ~ 4.5,
    bathrooms_text %in% c("5 baths") ~ 5,
    bathrooms_text %in% c("5.5 baths") ~ 5.5,
    bathrooms_text %in% c("6 baths") ~ 6,
    bathrooms_text %in% c("7 baths") ~ 7,
    bathrooms_text %in% c("7.5 baths") ~ 7.5,
    bathrooms_text %in% c("8 baths") ~ 8,
    bathrooms_text %in% c("11 baths", "11 shared baths", "11.5 shared baths") ~ 11,
    bathrooms_text %in% c("11.5 shared baths") ~ 11.5,
    TRUE ~ NA_real_  # For other values, set to NA
  )) |> 
  filter(!is.na(bathrooms)) |>   # Remove rows with NA in bathrooms
  # Keep bathrooms column after bathrooms_text
  relocate(bathrooms, .after = bathrooms_text) |>   
  select(-bathrooms_text)  # Remove the old bathrooms_text column
```

Entire home/apt = 0, Private room = 1, Hotel room = 2.

```{r echo=FALSE}
# Room type
listings_data <- listings_data |> 
  mutate(room = case_when(
    room_type %in% c("Entire home/apt") ~ 0,
    room_type %in% c("Private room") ~ 1,
    room_type %in% c("Hotel room") ~ 2,
    TRUE ~ NA_real_  # For other values, set to NA
  )) |> 
  filter(!is.na(room)) |>  # Remove rows with NA in room_type
  # Keep room column after bathrooms_text
  relocate(room, .after = room_type)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# write.csv(listings_data, "listings_data.csv")
```

### EDA

```{r echo=FALSE}
# Heatmap
# Select numerical columns for correlation analysis
numeric_data <- listings_data[, c('host_response_time', 'host_response_rate',
                                  'host_acceptance_rate', 'host_is_superhost',
                                  'host_listings_count', 'host_identity_verified',
                                  'latitude', 'longitude', 'room', 'accommodates',
                                  'bathrooms', 'bedrooms', 'beds', 'price', 'minimum_nights',
                                  'maximum_nights', 'number_of_reviews', 
                                  'review_scores_rating', 'review_scores_accuracy',
                                  'review_scores_cleanliness', 'review_scores_checkin',
                                  'review_scores_communication', 'review_scores_location',
                                  'review_scores_value', 'instant_bookable')]

# Correlation matrix
correlation_matrix <- cor(numeric_data, use="complete.obs")

# Heatmap
melted_correlation <- melt(correlation_matrix)
ggplot(data = melted_correlation, aes(Var1, Var2, fill = value)) +
    geom_tile() +
    geom_text(aes(label = sprintf("%.2f", value)), size = 1.5, vjust = 0.5) +
    scale_fill_gradientn(colours = c("#03045E", "#023E8A", "#277DA1", "#577590", "#4D908E",
                                     "#43AA8B", "#90BE6D", "#F9C74F", "#F9844A", "#F8961E",
                                     "#F3722C", "#F94144", "#DC2F02", "#D00000"),
                         limits = c(-1, 1)) +
    theme_minimal() +
    labs(title = "Correlation Matrix of Variables", x = '', y = '') +
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.text.x = element_text(angle = 45, hjust = 1)
      )
```

rate那里无所谓，但是中间那一块感觉会存在共线性问题

另外，相关系数矩阵仅仅表示不同变量之间是否存在线性关系，但有时候关系有可能是非线性的。（比如地理位置和价格）

找找哪些因素和price相关，然后绘制图形：

host_is_superhost, latitude and longitude, room_type, accommodates, bathrooms, bedrooms, beds, minimum_nights, number_of_reviews, review_scores_ratings, review_scores_location

```{r echo=FALSE}
# Price Distribution
ggplot(listings_data, aes(x = price)) +
  geom_histogram(binwidth = 10, fill = "#D62828", color = "black") +
  geom_density(aes(y = after_stat(count) * 10), color = "#003566", linewidth = 1) +
  labs(title = "Price Distribution", x = "Price", y = "Frequency") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

```{r echo=FALSE,message=FALSE,warning=FALSE}
# Scatter plot of the relationship between location and price
register_stadiamaps(key = "5a10d16e-591e-4614-be7c-c5294374aac7")
los_angeles_map <- get_stadiamap(bbox = c(left = -118.55, bottom = 33.95, right = -118.15, 
                                          top = 34.25), zoom = 12, maptype = "outdoors")
```

```{r echo=FALSE,warning=FALSE}
ggmap(los_angeles_map) +
  geom_point(data = listings_data, aes(x = longitude, y = latitude, color = price), 
             size = 1.5, alpha = 0.6) +
  scale_color_gradientn(colors = rev(RColorBrewer::brewer.pal(11, "RdYlBu"))) +
  labs(
    title = "Geographic Distribution of Listings Price in Los Angeles",
    x = "Longitude", y = "Latitude",
    color = "Price") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

```{r echo=FALSE}
# Room Type Distribution
ggplot(listings_data, aes(reorder(room_type, room_type, function(x) -length(x)), fill = room_type)) +
  geom_bar(color = "black") +
  scale_fill_manual(values = c("#D62828", "#F77F00", "#457B9D")) +
  labs(title = "Room Type Distribution", x = "Room Type", y = "Count") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  ) +
  geom_text(
    aes(label = after_stat(count)),
    stat = "count",
    position = position_stack(vjust = 0.5),
    color = c("white", "white", "black"),
    size = 4.5
  )
```

```{r echo=FALSE}
# Price Distribution of Different Room Types
# boxplot
ggplot(listings_data, aes(x = room_type, y = price, fill = room_type)) +
  geom_boxplot() +
  # scale_fill_brewer(palette = "Set2") +
  scale_fill_manual(values = c("#D62828", "#F77F00", "#457B9D")) +
  theme_minimal() +
  labs(title = "Price Distribution of Different Room Types",
       x = "Room Type",
       y = "Price") +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```

```{r}
# 散点图
ggplot(data, aes(x = accommodates, y = price)) +
  geom_point() +
  labs(title = "Price vs Accommodates", x = "Accommodates", y = "Price")
```

看一下评分数量的分布，来决定评分是否可以作为预测价格的指标

```{r}
# 评分分布（箱形图）
ggplot(listings_data, aes(x = review_scores_rating)) +
  geom_boxplot(fill = "yellow", color = "black") +
  labs(title = "Review Scores Rating Distribution", x = "Review Scores Rating", y = "Count") +
  theme_minimal()
```

```{r}
# 房东的响应时间和接受率（条形图）
ggplot(listings_data, aes(x = host_response_time, y = as.numeric(gsub("%", "", host_acceptance_rate)))) +
  geom_bar(stat = "identity", fill = "green", color = "black") +
  labs(title = "Host Response Time vs Acceptance Rate", x = "Host Response Time", y = "Acceptance Rate (%)") +
  theme_minimal()
```

```{r}
# 数据可视化

# 地理位置与价格关系散点图
ggplot(listings_data, aes(x=longitude, y=latitude, color=price)) +
  geom_point(alpha=0.5) +
  scale_color_gradient(low="blue", high="red") +
  theme_minimal() +
  labs(title="Geographic Location vs. Price of Airbnb Listings in Los Angeles",
       x="Longitude", y="Latitude")
```

### Fitting Model

#### Model1: Linear Regression

#### Residual plot

## Result

## Discussion

## Appendix
